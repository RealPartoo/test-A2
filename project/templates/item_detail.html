{% extends "base.html" %}
{% block title %}{{ item.title }} · Art lease{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <a href="{{ url_for('main.gallery') }}" class="text-decoration-none small">&larr; Back to Gallery</a>
    <span class="badge rounded-pill {{ 'text-bg-success' if item.leaseStatus=='Available' else 'text-bg-secondary' }}">
      {{ item.leaseStatus }}
    </span>
  </div>

  <div class="row g-4 g-lg-5">
    <!-- Image -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-2">
          <div class="ratio ratio-16x9 bg-light rounded-3 overflow-hidden">
            <img src="{{ url_for('static', filename=item.imageUrl) }}" alt="{{ item.title }}" class="img-fluid">
          </div>
        </div>
      </div>
    </div>

    <!-- Details -->
    <div class="col-12 col-lg-6">
      <h2 class="mb-2">{{ item.title }}</h2>

      <div class="mb-2">
        <div class="fw-semibold">
          {{ item.artistName }}{% if item.year %}, {{ item.year }}{% endif %}
        </div>
        {% if item.galleryName %}
          <div class="text-muted">{{ item.galleryName }}</div>
        {% endif %}
      </div>

      <div class="small text-muted mb-3">
        {% if item.type %}<span class="me-2">{{ item.type }}</span>{% endif %}
        {% if item.genre %}<span class="me-2">| {{ item.genre }}</span>{% endif %}
        {% if item.size %}<span class="me-2">| {{ item.size }}</span>{% endif %}
      </div>

      <div class="mt-3">
        <h6 class="text-muted mb-2">Description</h6>
        <p class="mb-0">{{ item.description or 'No description provided.' }}</p>
      </div>

      <div class="mt-4">
        <h6 class="text-muted mb-1">Price</h6>
        <div class="fs-4 fw-bold">
          AUD {{ '%.2f'|format(item.pricePerMonth|float) }}
          <span class="fs-6 fw-normal text-muted">/ month</span>
        </div>
      </div>

      <!-- Add to cart -->
      <div class="card mt-4 shadow-sm border-0 rounded-4">
        <div class="card-body">
          <form method="post"
                action="{{ url_for('main.cart_add', item_id=item.artworkId) }}"
                class="d-flex flex-column gap-3">

            <!-- Start date -->
            <div>
              <label for="startDate" class="form-label mb-1">Start date</label>
              <input type="date" id="startDate" name="startDate" class="form-control" required
                     {% if item.leaseStatus != 'Available' %}disabled{% endif %}>
              <div class="form-text">Choose the date your rental should begin.</div>
            </div>

            <!-- Months -->
            <div>
              <label for="months" class="form-label mb-1">Select rental period</label>
              <div class="input-group">
                <select id="months" name="months" class="form-select"
                        {% if item.leaseStatus != 'Available' %}disabled{% endif %}>
                  {% for m in range(1, 13) %}
                    <option value="{{ m }}">{{ m }}</option>
                  {% endfor %}
                </select>
                <span class="input-group-text">months</span>
                <button class="btn btn-dark" type="submit"
                        {% if item.leaseStatus != 'Available' %}disabled{% endif %}>
                  +Add
                </button>
              </div>
              {% if item.leaseStatus != 'Available' %}
                <div class="form-text text-danger mt-1">This artwork is currently unavailable.</div>
              {% endif %}
            </div>

            <!-- Preview -->
            <div class="p-3 border rounded bg-light">
              <div class="small text-muted">Preview</div>
              <div class="fw-semibold">
                <span id="preview-start">—</span>
                &nbsp;→&nbsp;
                <span id="preview-end">—</span>
              </div>
              <div class="mt-1">
                Estimated total:
                <span class="fw-semibold" id="preview-total">AUD 0.00</span>
              </div>
            </div>
          </form>

          <div class="text-end mt-3">
            <a href="{{ url_for('main.gallery') }}" class="btn btn-outline-secondary btn-sm">Back</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  const pricePerMonth = Number({{ (item.pricePerMonth or 0)|float }});
  const startEl = document.getElementById('startDate');
  const monthsEl = document.getElementById('months');
  const pStart = document.getElementById('preview-start');
  const pEnd   = document.getElementById('preview-end');
  const pTotal = document.getElementById('preview-total');

  // set min & default start = today
  const today = new Date();
  const toISO = d => d.toISOString().slice(0,10);
  const fmt   = d => d.toLocaleDateString(undefined, {year:'numeric', month:'2-digit', day:'2-digit'});
  if (startEl) {
    startEl.min = toISO(today);
    startEl.value = toISO(today);
  }

  function addMonths(d, n) {
    const y = d.getFullYear(), m = d.getMonth(), day = d.getDate();
    const ty = y + Math.floor((m + n) / 12);
    const tm = (m + n) % 12;
    const days = new Date(ty, tm + 1, 0).getDate();
    return new Date(ty, tm, Math.min(day, days));
  }

  function update() {
    if (!startEl || !monthsEl) return;
    const start = new Date(startEl.value || toISO(today));
    const months = Number(monthsEl.value || 1);
    const end = addMonths(start, months);
    pStart.textContent = fmt(start);
    pEnd.textContent   = fmt(end);
    pTotal.textContent = `AUD ${(pricePerMonth * months).toFixed(2)}`;
  }

  startEl && startEl.addEventListener('change', update);
  monthsEl && monthsEl.addEventListener('change', update);
  update();
})();
</script>
{% endblock %}
